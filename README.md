# My Application

The project is generated by [LoopBack 2.x](http://loopback.io).


##This repository

### The purpose

Our goal in this project is just to provide some training code and a tutorial to cretate a tiny serveur with loopback.

### The Example

We will try to build a server for manganing shops of cars.
The server should be able to: 
* Create a shop with starting cash
* A shop can buy and sell cars
* Get the cash available in the store


### Generate the serveur

This command will generate the server:

```bash
lb
```
By default, if you choose to build an API, you will get a built-in model: User

### Add Model

We need two models Car and Shop.
Let's generate them:

```bash
lb model
```

### Add relations between models

Let's have a look to our [LoopBack](http://loopback.io/doc/en/lb2/Tutorial-model-relations.html). 

In our case we want a shop to have several cars.
So we will use a **HasMany** relation.

```bash
lb relation
```

### Add remote method

#### cashAvailable

The first and easiest method we have to implement is cashAvailable.
It is aimed to give the current cash available.

|Type|Input|Output|
|---|---|---|
| GET | id | cashAvailable |

#####Define the function on the API

In the shop.js file, add

```javascript
Shop.remoteMethod(
        'cashAvailable', {
            http: {
                path: '/cashAvailable',
                verb: 'get'
            },
            accepts: {
                arg: 'id',
                type: 'string',
                http: {
                    source: 'query'
                }
            },
            returns: {
                arg: 'cashAvailable',
                type: 'number'
            }
        }
    );
```
#####Define the function itself

In the shop.js file define:

```javascript
Shop.cashAvailable = function(shopId, cb) {
    Shop.findById(shopId, function(err, instance) {
        console.log('instance', instance);
        var cashAvailable = instance.cash;
        cb(null, cashAvailable);
    });
};
```

#### buyCar

We want now to add a function to buyCar.
To handle the state of the car we will use a status property which values can be:
* product: the car has been producted but is not in a shop
* store: the car belongs to a shop
* custom: the car has been bought from the store


#####Define the function on the API

In the shop.js file, add

```javascript
 Shop.remoteMethod(
        'buyCar', {
            http: {
                path: '/buyCar',
                verb: 'get'
            },
            accepts: [{
                arg: 'ShopId',
                type: 'string',
                required: true
            }, {
                arg: 'CarId',
                type: 'string',
                required: true
            }],
            returns: {
                arg: 'reponse',
                type: 'number'
            }
        }
    );
```

#####Define the function itself

In the shop.js file define:

```nodejs
Shop.buyCar = function(shopId, carId, cb) {

        //From shop.js we need to access Car model
        var Car = Shop.app.models.Car;

        //get the Shop instance with the right id
        Shop.findById(shopId, function(err, instanceShop) {
            //get the Car instance with the right id
            Car.findById(carId, function(err2, instanceCar) {
                //Depending on the state of the car
                if (instanceCar != null) {
                    switch (instanceCar.status) {
                        case "product":
                            instanceCar.status = "store";
                            Car.upsert(instanceCar);
                            instanceShop.cash -= instanceCar.price;
                            Shop.upsert(instanceShop);
                            cb(null, "success");
                            break;
                        case "store":
                            cb(null, "Already belong to a store");
                            break;
                        case "custom":
                            instanceCar.status = "store";
                            Car.upsert(instanceCar);
                            instanceShop.cash -= instanceCar.price;
                            Shop.upsert(instanceShop);
                            cb(null, "You buy a second-hand car");
                            break;
                        default:
                            break;
                    }
                }
            });
        });
    };
```



